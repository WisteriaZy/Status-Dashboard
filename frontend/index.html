<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½“å‰ - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/common.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- ç™»å½•é¡µ -->
    <div id="login-page" class="min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-sm">
            <h1 class="text-2xl font-bold text-center mb-6">èº«ä»½éªŒè¯</h1>
            <p class="text-gray-500 text-sm text-center mb-6">è¯·è¾“å…¥éªŒè¯å™¨ä¸­çš„ 6 ä½éªŒè¯ç </p>
            <div class="space-y-4">
                <input type="text" id="totp-code" maxlength="6" pattern="[0-9]*" inputmode="numeric"
                    class="w-full text-center text-2xl tracking-widest py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                    placeholder="000000" autocomplete="one-time-code">
                <button onclick="submitTotp()" id="login-btn"
                    class="w-full py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium">
                    éªŒè¯
                </button>
                <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
            </div>
            <p class="text-gray-400 text-xs text-center mt-6">é¦–æ¬¡ä½¿ç”¨è¯·æ‰«æ config/totp_qrcode.png</p>
        </div>
    </div>

    <!-- ä¸»é¡µé¢ -->
    <div id="main-page">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <nav class="bg-white shadow-sm">
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex space-x-8">
                    <a href="/" class="tab-btn active py-4 px-1 font-medium text-gray-700 hover:text-blue-500">
                        å½“å‰
                    </a>
                    <a href="/static/tasks.html" class="tab-btn py-4 px-1 font-medium text-gray-500 hover:text-blue-500">
                        ä»»åŠ¡åˆ—è¡¨
                    </a>
                    <a href="/static/stats.html" class="tab-btn py-4 px-1 font-medium text-gray-500 hover:text-blue-500">
                        æ•°æ®å¯è§†åŒ–
                    </a>
                </div>
            </div>
        </nav>

        <!-- å†…å®¹åŒºåŸŸ -->
        <main class="max-w-6xl mx-auto px-4 py-6 pb-16">
            <div class="flex flex-col lg:flex-row lg:gap-4">
                <!-- å·¦æ ï¼šå½“å‰åº”ç”¨ & æ‰“å¼€åº”ç”¨ -->
                <div class="lg:w-1/2 space-y-4">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div id="current-app-info" class="text-gray-600">åŠ è½½ä¸­...</div>
                    </div>
                    <!-- æ­£åœ¨æ’­æ”¾ -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div id="media-info" class="text-gray-600"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div id="open-apps-info" class="text-gray-600"></div>
                    </div>
                </div>

                <!-- å³æ ï¼šç³»ç»Ÿä¿¡æ¯ & æˆªå›¾ -->
                <div class="lg:w-1/2 space-y-4 mt-4 lg:mt-0">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div id="device-info" class="text-gray-600"></div>
                    </div>
                    <!-- ç§»åŠ¨è®¾å¤‡ -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div id="mobile-devices-info" class="text-gray-600"></div>
                    </div>
                    <!-- æˆªå›¾åŒºåŸŸ -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-sm text-gray-500">å±å¹•æˆªå›¾</h2>
                            <button id="screenshot-btn" onclick="takeScreenshot()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                æˆªå›¾
                            </button>
                        </div>
                        <div id="screenshot-container" class="text-gray-500 text-sm">
                            ç‚¹å‡»æŒ‰é’®è·å–å½“å‰å±å¹•æˆªå›¾
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- åº•éƒ¨çŠ¶æ€æ  -->
        <footer class="fixed bottom-0 left-0 right-0 bg-white border-t px-4 py-2">
            <div class="max-w-6xl mx-auto flex justify-between text-sm text-gray-500">
                <span id="connection-status">â— å·²è¿æ¥</span>
                <span id="last-update">æœ€åæ›´æ–°: --</span>
            </div>
        </footer>
    </div>

    <script src="/static/common.js"></script>
    <script>
        let refreshInterval = null;

        // è®¤è¯æˆåŠŸåçš„å›è°ƒ
        function onAuthenticated() {
            fetchStatus();
            refreshInterval = setInterval(fetchStatus, 5000);
        }

        // è·å–çŠ¶æ€æ•°æ®
        async function fetchStatus() {
            try {
                const res = await fetch('/api/status');

                if (handleUnauthorized(res)) return;

                const data = await res.json();

                // å·¦æ ï¼šå½“å‰åº”ç”¨
                document.getElementById('current-app-info').innerHTML = `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="text-sm text-gray-500 mb-1">å½“å‰åº”ç”¨</div>
                            <div class="text-sm text-blue-500">${data.current_app.usage_formatted || ''}</div>
                        </div>
                        <div class="text-2xl font-semibold">${data.current_app.name}</div>
                        <div class="text-gray-600 mt-1 truncate" title="${data.current_app.title}">
                            ${data.current_app.title || '(æ— æ ‡é¢˜)'}
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            ${data.current_app.process_name} (PID: ${data.current_app.pid})
                        </div>
                    </div>
                `;

                // å·¦æ ï¼šæ­£åœ¨æ’­æ”¾ï¼ˆSMTCï¼‰
                const media = data.media;
                if (media.available) {
                    const statusText = {
                        'playing': 'æ’­æ”¾ä¸­',
                        'paused': 'å·²æš‚åœ',
                        'stopped': 'å·²åœæ­¢',
                    }[media.playback_status] || media.playback_status;

                    document.getElementById('media-info').innerHTML = `
                        <div class="text-sm text-gray-500 mb-2">æ­£åœ¨æ’­æ”¾</div>
                        <div class="flex gap-4">
                            ${media.thumbnail ? `<img src="${media.thumbnail}" alt="å°é¢" class="w-16 h-16 rounded object-cover flex-shrink-0">` : ''}
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold truncate" title="${media.title}">${media.title}</div>
                                <div class="text-sm text-gray-600 truncate">${media.artist}</div>
                                <div class="text-xs text-gray-400 truncate">${media.album}</div>
                                <div class="text-xs mt-1">
                                    <span class="${media.playback_status === 'playing' ? 'text-green-500' : 'text-gray-400'}">${statusText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('media-info').innerHTML = `
                        <div class="text-sm text-gray-500 mb-2">æ­£åœ¨æ’­æ”¾</div>
                        <div class="text-gray-400 text-sm">æš‚æ— åª’ä½“æ’­æ”¾</div>
                    `;
                }

                // å·¦æ ï¼šæ‰“å¼€çš„åº”ç”¨ï¼ˆå·²æŒ‰ä½¿ç”¨æ—¶é—´æ’åºï¼‰
                const appsHtml = data.open_apps.map(app => `
                    <div class="flex items-center py-2 px-3 hover:bg-gray-100 rounded ${app.pid === data.current_app.pid ? 'bg-blue-50 border-l-2 border-blue-500' : ''}">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-sm">${app.app_name}</div>
                            <div class="text-xs text-gray-500 truncate" title="${app.title}">${app.title}</div>
                        </div>
                        <div class="text-xs text-gray-400 ml-2 flex-shrink-0">${app.usage_formatted || ''}</div>
                    </div>
                `).join('');

                document.getElementById('open-apps-info').innerHTML = `
                    <div class="text-sm text-gray-500 mb-2">æ‰“å¼€çš„åº”ç”¨ (${data.open_apps.length}) <span class="text-xs text-gray-400">æŒ‰ä½¿ç”¨æ—¶é—´æ’åº</span></div>
                    <div class="space-y-1 max-h-96 overflow-y-auto">
                        ${appsHtml || '<div class="text-gray-400 text-sm">æ— æ‰“å¼€çš„åº”ç”¨</div>'}
                    </div>
                `;

                // å³æ ï¼šè®¾å¤‡ä¿¡æ¯
                const disksHtml = data.device.disks.map(disk => `
                    <div class="bg-white rounded p-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-medium text-sm">${disk.device}</span>
                            <span class="text-xs text-gray-500">${disk.fstype}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                            <div class="h-2 rounded-full ${disk.percent > 90 ? 'bg-red-500' : disk.percent > 70 ? 'bg-yellow-500' : 'bg-blue-500'}" style="width: ${disk.percent}%"></div>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${disk.used_gb} / ${disk.total_gb} GB (${disk.percent}%)
                        </div>
                    </div>
                `).join('');

                document.getElementById('device-info').innerHTML = `
                    <div class="space-y-4">
                        <div class="text-sm text-gray-500 mb-2">ç³»ç»Ÿä¿¡æ¯</div>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-gray-50 rounded-lg p-3 text-center">
                                <div class="text-sm text-gray-500">CPU</div>
                                <div class="text-xl font-semibold">${data.device.cpu_percent}%</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3 text-center">
                                <div class="text-sm text-gray-500">å†…å­˜</div>
                                <div class="text-xl font-semibold">${data.device.memory_percent}%</div>
                                <div class="text-xs text-gray-400">${data.device.memory_used_gb}/${data.device.memory_total_gb} GB</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3 text-center">
                                <div class="text-sm text-gray-500">è¿è¡Œæ—¶é—´</div>
                                <div class="text-xl font-semibold">${data.device.uptime_formatted}</div>
                            </div>
                        </div>

                        <div>
                            <div class="text-sm text-gray-500 mb-2">ç£ç›˜</div>
                            <div class="grid grid-cols-2 gap-2">
                                ${disksHtml || '<div class="text-gray-400 text-sm">æ— ç£ç›˜ä¿¡æ¯</div>'}
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('last-update').textContent =
                    'æœ€åæ›´æ–°: ' + new Date().toLocaleTimeString();
                document.getElementById('connection-status').innerHTML =
                    '<span class="text-green-500">â—</span> å·²è¿æ¥';

                // è·å–ç§»åŠ¨è®¾å¤‡çŠ¶æ€
                fetchMobileDevices();
            } catch (e) {
                document.getElementById('connection-status').innerHTML =
                    '<span class="text-red-500">â—</span> è¿æ¥å¤±è´¥';
            }
        }

        // è·å–ç§»åŠ¨è®¾å¤‡çŠ¶æ€
        async function fetchMobileDevices() {
            try {
                const res = await fetch('/api/devices');
                if (!res.ok) return;

                const data = await res.json();
                const container = document.getElementById('mobile-devices-info');

                if (data.devices.length === 0) {
                    container.innerHTML = `
                        <div class="text-sm text-gray-500 mb-2">ç§»åŠ¨è®¾å¤‡</div>
                        <div class="text-gray-400 text-sm">æš‚æ— è®¾å¤‡è¿æ¥</div>
                    `;
                    return;
                }

                const devicesHtml = data.devices.map(d => {
                    const statusColor = d.online ? (d.using ? 'text-green-500' : 'text-yellow-500') : 'text-gray-400';
                    const statusText = d.online ? (d.using ? 'ä½¿ç”¨ä¸­' : 'å¾…æœº') : 'ç¦»çº¿';
                    const batteryIcon = d.charging ? 'âš¡' : 'ğŸ”‹';
                    const batteryText = d.battery !== null ? `${batteryIcon} ${d.battery}%` : '';

                    return `
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium">${d.show_name}</div>
                                    <div class="text-sm text-gray-600 truncate">${d.using ? d.app_name : 'æœªåœ¨ä½¿ç”¨'}</div>
                                </div>
                                <div class="text-right text-xs">
                                    <div class="${statusColor}">${statusText}</div>
                                    ${batteryText ? `<div class="text-gray-500 mt-1">${batteryText}</div>` : ''}
                                </div>
                            </div>
                            <div class="text-xs text-gray-400 mt-2">æ›´æ–°äº ${d.last_update}</div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <div class="text-sm text-gray-500 mb-2">ç§»åŠ¨è®¾å¤‡ (${data.devices.length})</div>
                    <div class="space-y-2">${devicesHtml}</div>
                `;
            } catch {}
        }

        // æˆªå›¾åŠŸèƒ½
        async function takeScreenshot() {
            const btn = document.getElementById('screenshot-btn');
            const container = document.getElementById('screenshot-container');

            btn.disabled = true;
            btn.textContent = 'æˆªå›¾ä¸­...';
            container.innerHTML = '<div class="text-gray-400">æ­£åœ¨è·å–æˆªå›¾...</div>';

            try {
                const res = await fetch('/api/screenshot', { method: 'POST' });

                if (handleUnauthorized(res)) return;

                const data = await res.json();

                if (data.success) {
                    container.innerHTML = `
                        <div class="space-y-2">
                            <div class="text-xs text-gray-400">
                                ${data.timestamp} Â· ${data.width}x${data.height}
                            </div>
                            <img src="${data.base64}" alt="æˆªå›¾" class="w-full rounded-lg border cursor-pointer hover:opacity-90" onclick="window.open(this.src, '_blank')">
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="text-red-500">æˆªå›¾å¤±è´¥: ${data.error}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="text-red-500">è¯·æ±‚å¤±è´¥: ${e.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'æˆªå›¾';
            }
        }

        // å¯åŠ¨åº”ç”¨
        initApp();
    </script>
</body>
</html>
