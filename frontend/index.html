<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Device Status Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        #login-page { display: none; }
        #main-page { display: none; }
        .remind-panel { display: none; }
        .remind-panel.active { display: block; }
        .hour-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; }
        .hour-btn, .weekday-btn, .day-btn {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .hour-btn:hover, .weekday-btn:hover, .day-btn:hover { background: #e5e7eb; }
        .hour-btn.selected, .weekday-btn.selected, .day-btn.selected {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .day-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- ç™»å½•é¡µ -->
    <div id="login-page" class="min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-sm">
            <h1 class="text-2xl font-bold text-center mb-6">èº«ä»½éªŒè¯</h1>
            <p class="text-gray-500 text-sm text-center mb-6">è¯·è¾“å…¥éªŒè¯å™¨ä¸­çš„ 6 ä½éªŒè¯ç </p>
            <div class="space-y-4">
                <input type="text" id="totp-code" maxlength="6" pattern="[0-9]*" inputmode="numeric"
                    class="w-full text-center text-2xl tracking-widest py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                    placeholder="000000" autocomplete="one-time-code">
                <button onclick="submitTotp()" id="login-btn"
                    class="w-full py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium">
                    éªŒè¯
                </button>
                <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
            </div>
            <p class="text-gray-400 text-xs text-center mt-6">é¦–æ¬¡ä½¿ç”¨è¯·æ‰«æ config/totp_qrcode.png</p>
        </div>
    </div>

    <!-- ä¸»é¡µé¢ -->
    <div id="main-page">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <nav class="bg-white shadow-sm">
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex space-x-8">
                    <button class="tab-btn active py-4 px-1 font-medium text-gray-700 hover:text-blue-500" data-tab="current">
                        å½“å‰
                    </button>
                    <button class="tab-btn py-4 px-1 font-medium text-gray-500 hover:text-blue-500" data-tab="tasks">
                        ä»»åŠ¡åˆ—è¡¨
                    </button>
                    <button class="tab-btn py-4 px-1 font-medium text-gray-500 hover:text-blue-500" data-tab="stats">
                        æ•°æ®å¯è§†åŒ–
                    </button>
                </div>
            </div>
        </nav>

        <!-- å†…å®¹åŒºåŸŸ -->
        <main class="max-w-6xl mx-auto px-4 py-6 pb-16">
            <!-- å½“å‰ -->
            <div id="tab-current" class="tab-content active">
                <div class="flex flex-col lg:flex-row lg:gap-4">
                    <!-- å·¦æ ï¼šå½“å‰åº”ç”¨ & æ‰“å¼€åº”ç”¨ -->
                    <div class="lg:w-1/2 space-y-4">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div id="current-app-info" class="text-gray-600">åŠ è½½ä¸­...</div>
                        </div>
                        <!-- æ­£åœ¨æ’­æ”¾ -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <div id="media-info" class="text-gray-600"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div id="open-apps-info" class="text-gray-600"></div>
                        </div>
                    </div>

                    <!-- å³æ ï¼šç³»ç»Ÿä¿¡æ¯ & æˆªå›¾ -->
                    <div class="lg:w-1/2 space-y-4 mt-4 lg:mt-0">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div id="device-info" class="text-gray-600"></div>
                        </div>
                        <!-- ç§»åŠ¨è®¾å¤‡ -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <div id="mobile-devices-info" class="text-gray-600"></div>
                        </div>
                        <!-- æˆªå›¾åŒºåŸŸ -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-sm text-gray-500">å±å¹•æˆªå›¾</h2>
                                <button id="screenshot-btn" onclick="takeScreenshot()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                    æˆªå›¾
                                </button>
                            </div>
                            <div id="screenshot-container" class="text-gray-500 text-sm">
                                ç‚¹å‡»æŒ‰é’®è·å–å½“å‰å±å¹•æˆªå›¾
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div id="tab-tasks" class="tab-content">
                <div class="space-y-4">
                    <!-- æ·»åŠ ä»»åŠ¡ -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="new-task-input" placeholder="æ·»åŠ æ–°ä»»åŠ¡..."
                                class="flex-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                onkeypress="if(event.key==='Enter')addTask()">
                            <button onclick="toggleImportantInput()" id="important-btn" class="px-3 py-2 text-gray-400 hover:text-yellow-500 text-lg" title="æ ‡è®°é‡è¦">â˜†</button>
                            <button onclick="addTask()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                æ·»åŠ 
                            </button>
                        </div>
                        <div class="flex items-center gap-4 text-sm">
                            <label class="flex items-center gap-1 text-gray-500">
                                <input type="checkbox" id="show-completed" onchange="loadTasks()" class="rounded">
                                æ˜¾ç¤ºå·²å®Œæˆ
                            </label>
                            <button onclick="loadTasks()" class="text-gray-500 hover:text-blue-500">åˆ·æ–°</button>
                        </div>
                    </div>

                    <!-- ä»»åŠ¡åˆ—è¡¨ -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div id="tasks-container" class="text-gray-600">
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®å¯è§†åŒ– -->
            <div id="tab-stats" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">æ•°æ®å¯è§†åŒ–</h2>
                    <p class="text-gray-500">ç»Ÿè®¡å›¾è¡¨ï¼ˆå¾…å¼€å‘ï¼‰</p>
                </div>
            </div>
        </main>

        <!-- åº•éƒ¨çŠ¶æ€æ  -->
        <footer class="fixed bottom-0 left-0 right-0 bg-white border-t px-4 py-2">
            <div class="max-w-6xl mx-auto flex justify-between text-sm text-gray-500">
                <span id="connection-status">â— å·²è¿æ¥</span>
                <span id="last-update">æœ€åæ›´æ–°: --</span>
            </div>
        </footer>
    </div>

    <script>
        let refreshInterval = null;

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuth() {
            try {
                const res = await fetch('/api/auth/status');
                const data = await res.json();
                return data.authenticated;
            } catch {
                return false;
            }
        }

        // æ˜¾ç¤ºç™»å½•é¡µæˆ–ä¸»é¡µ
        async function initApp() {
            const authenticated = await checkAuth();
            if (authenticated) {
                showMainPage();
            } else {
                showLoginPage();
            }
        }

        function showLoginPage() {
            document.getElementById('login-page').style.display = 'flex';
            document.getElementById('main-page').style.display = 'none';
            document.getElementById('totp-code').focus();
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        function showMainPage() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-page').style.display = 'block';
            fetchStatus();
            refreshInterval = setInterval(fetchStatus, 5000);
            loadTasks();
        }

        // æäº¤éªŒè¯ç 
        async function submitTotp() {
            const code = document.getElementById('totp-code').value.trim();
            const errorEl = document.getElementById('login-error');
            const btn = document.getElementById('login-btn');

            if (!/^\d{6}$/.test(code)) {
                errorEl.textContent = 'è¯·è¾“å…¥ 6 ä½æ•°å­—éªŒè¯ç ';
                errorEl.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'éªŒè¯ä¸­...';
            errorEl.classList.add('hidden');

            try {
                const res = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code }),
                });

                if (res.ok) {
                    showMainPage();
                } else {
                    const data = await res.json();
                    errorEl.textContent = data.detail || 'éªŒè¯å¤±è´¥';
                    errorEl.classList.remove('hidden');
                }
            } catch (e) {
                errorEl.textContent = 'ç½‘ç»œé”™è¯¯';
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'éªŒè¯';
            }
        }

        // å›è½¦æäº¤
        document.getElementById('totp-code').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitTotp();
        });

        // æ ‡ç­¾é¡µåˆ‡æ¢é€»è¾‘
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            });
        });

        // è·å–çŠ¶æ€æ•°æ®
        async function fetchStatus() {
            try {
                const res = await fetch('/api/status');

                // æœªè®¤è¯åˆ™è·³è½¬ç™»å½•
                if (res.status === 401) {
                    showLoginPage();
                    return;
                }

                const data = await res.json();

                // å·¦æ ï¼šå½“å‰åº”ç”¨
                document.getElementById('current-app-info').innerHTML = `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-sm text-gray-500 mb-1">å½“å‰åº”ç”¨</div>
                        <div class="text-2xl font-semibold">${data.current_app.name}</div>
                        <div class="text-gray-600 mt-1 truncate" title="${data.current_app.title}">
                            ${data.current_app.title || '(æ— æ ‡é¢˜)'}
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            ${data.current_app.process_name} (PID: ${data.current_app.pid})
                        </div>
                    </div>
                `;

                // å·¦æ ï¼šæ­£åœ¨æ’­æ”¾ï¼ˆSMTCï¼‰
                const media = data.media;
                if (media.available) {
                    const statusText = {
                        'playing': 'æ’­æ”¾ä¸­',
                        'paused': 'å·²æš‚åœ',
                        'stopped': 'å·²åœæ­¢',
                    }[media.playback_status] || media.playback_status;

                    document.getElementById('media-info').innerHTML = `
                        <div class="text-sm text-gray-500 mb-2">æ­£åœ¨æ’­æ”¾</div>
                        <div class="flex gap-4">
                            ${media.thumbnail ? `<img src="${media.thumbnail}" alt="å°é¢" class="w-16 h-16 rounded object-cover flex-shrink-0">` : ''}
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold truncate" title="${media.title}">${media.title}</div>
                                <div class="text-sm text-gray-600 truncate">${media.artist}</div>
                                <div class="text-xs text-gray-400 truncate">${media.album}</div>
                                <div class="text-xs mt-1">
                                    <span class="${media.playback_status === 'playing' ? 'text-green-500' : 'text-gray-400'}">${statusText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('media-info').innerHTML = `
                        <div class="text-sm text-gray-500 mb-2">æ­£åœ¨æ’­æ”¾</div>
                        <div class="text-gray-400 text-sm">æš‚æ— åª’ä½“æ’­æ”¾</div>
                    `;
                }

                // å·¦æ ï¼šæ‰“å¼€çš„åº”ç”¨
                const appsHtml = data.open_apps.map(app => `
                    <div class="flex items-center py-2 px-3 hover:bg-gray-100 rounded ${app.pid === data.current_app.pid ? 'bg-blue-50 border-l-2 border-blue-500' : ''}">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-sm">${app.app_name}</div>
                            <div class="text-xs text-gray-500 truncate" title="${app.title}">${app.title}</div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('open-apps-info').innerHTML = `
                    <div class="text-sm text-gray-500 mb-2">æ‰“å¼€çš„åº”ç”¨ (${data.open_apps.length})</div>
                    <div class="space-y-1 max-h-96 overflow-y-auto">
                        ${appsHtml || '<div class="text-gray-400 text-sm">æ— æ‰“å¼€çš„åº”ç”¨</div>'}
                    </div>
                `;

                // å³æ ï¼šè®¾å¤‡ä¿¡æ¯
                const disksHtml = data.device.disks.map(disk => `
                    <div class="bg-white rounded p-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-medium text-sm">${disk.device}</span>
                            <span class="text-xs text-gray-500">${disk.fstype}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                            <div class="h-2 rounded-full ${disk.percent > 90 ? 'bg-red-500' : disk.percent > 70 ? 'bg-yellow-500' : 'bg-blue-500'}" style="width: ${disk.percent}%"></div>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${disk.used_gb} / ${disk.total_gb} GB (${disk.percent}%)
                        </div>
                    </div>
                `).join('');

                document.getElementById('device-info').innerHTML = `
                    <div class="space-y-4">
                        <div class="text-sm text-gray-500 mb-2">ç³»ç»Ÿä¿¡æ¯</div>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-gray-50 rounded-lg p-3 text-center">
                                <div class="text-sm text-gray-500">CPU</div>
                                <div class="text-xl font-semibold">${data.device.cpu_percent}%</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3 text-center">
                                <div class="text-sm text-gray-500">å†…å­˜</div>
                                <div class="text-xl font-semibold">${data.device.memory_percent}%</div>
                                <div class="text-xs text-gray-400">${data.device.memory_used_gb}/${data.device.memory_total_gb} GB</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3 text-center">
                                <div class="text-sm text-gray-500">è¿è¡Œæ—¶é—´</div>
                                <div class="text-xl font-semibold">${data.device.uptime_formatted}</div>
                            </div>
                        </div>

                        <div>
                            <div class="text-sm text-gray-500 mb-2">ç£ç›˜</div>
                            <div class="grid grid-cols-2 gap-2">
                                ${disksHtml || '<div class="text-gray-400 text-sm">æ— ç£ç›˜ä¿¡æ¯</div>'}
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('last-update').textContent =
                    'æœ€åæ›´æ–°: ' + new Date().toLocaleTimeString();
                document.getElementById('connection-status').innerHTML =
                    '<span class="text-green-500">â—</span> å·²è¿æ¥';

                // è·å–ç§»åŠ¨è®¾å¤‡çŠ¶æ€
                fetchMobileDevices();
            } catch (e) {
                document.getElementById('connection-status').innerHTML =
                    '<span class="text-red-500">â—</span> è¿æ¥å¤±è´¥';
            }
        }

        // è·å–ç§»åŠ¨è®¾å¤‡çŠ¶æ€
        async function fetchMobileDevices() {
            try {
                const res = await fetch('/api/devices');
                if (!res.ok) return;

                const data = await res.json();
                const container = document.getElementById('mobile-devices-info');

                if (data.devices.length === 0) {
                    container.innerHTML = `
                        <div class="text-sm text-gray-500 mb-2">ç§»åŠ¨è®¾å¤‡</div>
                        <div class="text-gray-400 text-sm">æš‚æ— è®¾å¤‡è¿æ¥</div>
                    `;
                    return;
                }

                const devicesHtml = data.devices.map(d => {
                    const statusColor = d.online ? (d.using ? 'text-green-500' : 'text-yellow-500') : 'text-gray-400';
                    const statusText = d.online ? (d.using ? 'ä½¿ç”¨ä¸­' : 'å¾…æœº') : 'ç¦»çº¿';
                    const batteryIcon = d.charging ? 'âš¡' : 'ğŸ”‹';
                    const batteryText = d.battery !== null ? `${batteryIcon} ${d.battery}%` : '';

                    return `
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium">${d.show_name}</div>
                                    <div class="text-sm text-gray-600 truncate">${d.using ? d.app_name : 'æœªåœ¨ä½¿ç”¨'}</div>
                                </div>
                                <div class="text-right text-xs">
                                    <div class="${statusColor}">${statusText}</div>
                                    ${batteryText ? `<div class="text-gray-500 mt-1">${batteryText}</div>` : ''}
                                </div>
                            </div>
                            <div class="text-xs text-gray-400 mt-2">æ›´æ–°äº ${d.last_update}</div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <div class="text-sm text-gray-500 mb-2">ç§»åŠ¨è®¾å¤‡ (${data.devices.length})</div>
                    <div class="space-y-2">${devicesHtml}</div>
                `;
            } catch {}
        }

        // æˆªå›¾åŠŸèƒ½
        async function takeScreenshot() {
            const btn = document.getElementById('screenshot-btn');
            const container = document.getElementById('screenshot-container');

            btn.disabled = true;
            btn.textContent = 'æˆªå›¾ä¸­...';
            container.innerHTML = '<div class="text-gray-400">æ­£åœ¨è·å–æˆªå›¾...</div>';

            try {
                const res = await fetch('/api/screenshot', { method: 'POST' });

                if (res.status === 401) {
                    showLoginPage();
                    return;
                }

                const data = await res.json();

                if (data.success) {
                    container.innerHTML = `
                        <div class="space-y-2">
                            <div class="text-xs text-gray-400">
                                ${data.timestamp} Â· ${data.width}x${data.height}
                            </div>
                            <img src="${data.base64}" alt="æˆªå›¾" class="w-full rounded-lg border cursor-pointer hover:opacity-90" onclick="window.open(this.src, '_blank')">
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="text-red-500">æˆªå›¾å¤±è´¥: ${data.error}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="text-red-500">è¯·æ±‚å¤±è´¥: ${e.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'æˆªå›¾';
            }
        }

        // å¯åŠ¨åº”ç”¨
        initApp();

        // ========== æœ¬åœ° TODO ==========

        let newTaskImportant = false;

        function toggleImportantInput() {
            newTaskImportant = !newTaskImportant;
            const btn = document.getElementById('important-btn');
            btn.textContent = newTaskImportant ? 'â˜…' : 'â˜†';
            btn.classList.toggle('text-yellow-500', newTaskImportant);
            btn.classList.toggle('text-gray-400', !newTaskImportant);
        }

        async function loadTasks() {
            const showCompleted = document.getElementById('show-completed')?.checked || false;
            const container = document.getElementById('tasks-container');

            try {
                const res = await fetch(`/api/todo/tasks?include_completed=${showCompleted}`);
                if (res.status === 401) {
                    showLoginPage();
                    return;
                }
                const data = await res.json();

                if (data.tasks.length === 0) {
                    container.innerHTML = '<div class="text-gray-400 text-sm text-center py-4">æ²¡æœ‰å¾…åŠä»»åŠ¡</div>';
                    return;
                }

                // åˆ†ç¦»çˆ¶ä»»åŠ¡å’Œå­ä»»åŠ¡
                const parentTasks = data.tasks.filter(t => !t.parent_id);
                const childTasks = data.tasks.filter(t => t.parent_id);

                const tasksHtml = parentTasks.map(task => {
                    const children = childTasks.filter(c => c.parent_id === task.id);
                    return renderTask(task, children);
                }).join('');

                container.innerHTML = tasksHtml || '<div class="text-gray-400 text-sm text-center py-4">æ²¡æœ‰å¾…åŠä»»åŠ¡</div>';
            } catch (e) {
                container.innerHTML = `<div class="text-red-500 text-sm">åŠ è½½å¤±è´¥</div>`;
            }
        }

        function renderTask(task, children = []) {
            const importantStar = task.important ? 'â˜…' : '';
            const completedClass = task.completed ? 'line-through text-gray-400' : '';
            const checkIcon = task.completed ? 'âœ“' : '';

            let childrenHtml = '';
            if (children.length > 0) {
                childrenHtml = `<div class="ml-6 mt-2 space-y-1 border-l-2 border-gray-200 pl-3">
                    ${children.map(c => renderTask(c, [])).join('')}
                </div>`;
            }

            // æé†’ä¿¡æ¯æ‘˜è¦
            const remindSummary = getRemindSummary(task);
            const hasRemind = task.remind || task.remind_at;

            return `
                <div class="py-3 border-b last:border-0 group" data-task-id="${task.id}">
                    <div class="flex items-start gap-3">
                        <button onclick="completeTask('${task.id}')" class="mt-1 w-5 h-5 rounded-full border-2 ${task.completed ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-green-500 hover:bg-green-50'} flex-shrink-0 transition-colors flex items-center justify-center text-xs" title="${task.completed ? 'å·²å®Œæˆ' : 'å®Œæˆ'}">${checkIcon}</button>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm ${completedClass}">
                                ${importantStar ? `<span class="text-yellow-500 mr-1">${importantStar}</span>` : ''}
                                ${task.title}
                            </div>
                            ${task.notes ? `<div class="text-xs text-gray-400 mt-1">${task.notes}</div>` : ''}
                            ${remindSummary ? `<div class="text-xs text-blue-400 mt-1">ğŸ”” ${remindSummary}</div>` : ''}
                        </div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="toggleRemindPanel('${task.id}')" class="text-gray-300 hover:text-blue-500 text-sm ${hasRemind ? 'text-blue-400' : ''}" title="è®¾ç½®æé†’">ğŸ””</button>
                            <button onclick="toggleImportant('${task.id}')" class="text-gray-300 hover:text-yellow-500 text-sm" title="åˆ‡æ¢é‡è¦">â˜…</button>
                            <button onclick="promptAddSubtask('${task.id}')" class="text-gray-300 hover:text-blue-500 text-sm" title="æ·»åŠ å­ä»»åŠ¡">+</button>
                            <button onclick="deleteTask('${task.id}')" class="text-gray-300 hover:text-red-500 text-sm" title="åˆ é™¤">âœ•</button>
                        </div>
                    </div>
                    <!-- æé†’è®¾ç½®é¢æ¿ -->
                    <div id="remind-panel-${task.id}" class="remind-panel mt-3 ml-8 p-3 bg-gray-50 rounded-lg text-sm">
                        ${renderRemindPanel(task)}
                    </div>
                    ${childrenHtml}
                </div>
            `;
        }

        function getRemindSummary(task) {
            // å…¼å®¹æ—§æ ¼å¼
            if (task.remind_at && !task.remind) {
                return new Date(task.remind_at).toLocaleString();
            }

            const remind = task.remind;
            if (!remind) return '';

            if (remind.type === 'once') {
                return `ä¸€æ¬¡æ€§ï¼š${new Date(remind.at).toLocaleString()}`;
            } else if (remind.type === 'daily') {
                const hours = remind.hours || [];
                return `æ¯å¤© ${hours.map(h => h + ':00').join(', ')}`;
            } else if (remind.type === 'weekly') {
                const weekdayNames = ['', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
                const days = (remind.weekdays || []).map(d => weekdayNames[d]).join(', ');
                return `æ¯å‘¨ ${days} ${remind.hour}:00`;
            } else if (remind.type === 'monthly') {
                const days = (remind.days || []).join(', ');
                return `æ¯æœˆ ${days}æ—¥ ${remind.hour}:00`;
            }
            return '';
        }

        function renderRemindPanel(task) {
            const remind = task.remind || {};
            const remindType = remind.type || 'none';
            const remindTag = task.remind_tag || 'ç§äºº';

            // å°æ—¶é€‰æ‹©å™¨
            let hoursGrid = '<div class="hour-grid mt-2">';
            for (let h = 0; h < 24; h++) {
                const selected = (remind.hours || []).includes(h) ? 'selected' : '';
                hoursGrid += `<button type="button" class="hour-btn ${selected}" data-hour="${h}">${h}</button>`;
            }
            hoursGrid += '</div>';

            // æ˜ŸæœŸé€‰æ‹©å™¨
            const weekdayNames = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
            let weekdaysGrid = '<div class="flex gap-1 mt-2">';
            for (let d = 1; d <= 7; d++) {
                const selected = (remind.weekdays || []).includes(d) ? 'selected' : '';
                weekdaysGrid += `<button type="button" class="weekday-btn ${selected}" data-weekday="${d}">${weekdayNames[d-1]}</button>`;
            }
            weekdaysGrid += '</div>';

            // æ—¥æœŸé€‰æ‹©å™¨ (1-31)
            let daysGrid = '<div class="day-grid mt-2">';
            for (let d = 1; d <= 31; d++) {
                const selected = (remind.days || []).includes(d) ? 'selected' : '';
                daysGrid += `<button type="button" class="day-btn ${selected}" data-day="${d}">${d}</button>`;
            }
            daysGrid += '</div>';

            // å°æ—¶ä¸‹æ‹‰é€‰æ‹©
            let hourSelect = '<select class="remind-hour-select border rounded px-2 py-1 text-sm">';
            for (let h = 0; h < 24; h++) {
                const selected = remind.hour === h ? 'selected' : '';
                hourSelect += `<option value="${h}" ${selected}>${h}:00</option>`;
            }
            hourSelect += '</select>';

            // ä¸€æ¬¡æ€§æ—¶é—´è¾“å…¥
            const onceAt = remind.at || '';

            return `
                <div class="space-y-3">
                    <div>
                        <label class="block text-gray-600 mb-1">æé†’ç±»å‹</label>
                        <select class="remind-type-select w-full border rounded px-2 py-1" onchange="onRemindTypeChange('${task.id}', this.value)">
                            <option value="none" ${remindType === 'none' ? 'selected' : ''}>æ— æé†’</option>
                            <option value="once" ${remindType === 'once' ? 'selected' : ''}>ä¸€æ¬¡æ€§</option>
                            <option value="daily" ${remindType === 'daily' ? 'selected' : ''}>æ¯å¤©</option>
                            <option value="weekly" ${remindType === 'weekly' ? 'selected' : ''}>æ¯å‘¨</option>
                            <option value="monthly" ${remindType === 'monthly' ? 'selected' : ''}>æ¯æœˆ</option>
                        </select>
                    </div>

                    <!-- ä¸€æ¬¡æ€§ -->
                    <div class="remind-once-options ${remindType === 'once' ? '' : 'hidden'}">
                        <label class="block text-gray-600 mb-1">æé†’æ—¶é—´</label>
                        <input type="datetime-local" class="remind-once-at w-full border rounded px-2 py-1" value="${onceAt ? onceAt.slice(0, 16) : ''}">
                    </div>

                    <!-- æ¯å¤© -->
                    <div class="remind-daily-options ${remindType === 'daily' ? '' : 'hidden'}">
                        <label class="block text-gray-600 mb-1">é€‰æ‹©å°æ—¶ï¼ˆå¯å¤šé€‰ï¼‰</label>
                        ${hoursGrid}
                    </div>

                    <!-- æ¯å‘¨ -->
                    <div class="remind-weekly-options ${remindType === 'weekly' ? '' : 'hidden'}">
                        <label class="block text-gray-600 mb-1">é€‰æ‹©æ˜ŸæœŸï¼ˆå¯å¤šé€‰ï¼‰</label>
                        ${weekdaysGrid}
                        <label class="block text-gray-600 mt-2 mb-1">æé†’æ—¶é—´</label>
                        ${hourSelect}
                    </div>

                    <!-- æ¯æœˆ -->
                    <div class="remind-monthly-options ${remindType === 'monthly' ? '' : 'hidden'}">
                        <label class="block text-gray-600 mb-1">é€‰æ‹©æ—¥æœŸï¼ˆå¯å¤šé€‰ï¼‰</label>
                        ${daysGrid}
                        <label class="block text-gray-600 mt-2 mb-1">æé†’æ—¶é—´</label>
                        ${hourSelect}
                    </div>

                    <!-- é€šçŸ¥ç›®æ ‡ -->
                    <div>
                        <label class="block text-gray-600 mb-1">é€šçŸ¥ç›®æ ‡</label>
                        <select class="remind-tag-select w-full border rounded px-2 py-1">
                            <option value="ç§äºº" ${remindTag === 'ç§äºº' ? 'selected' : ''}>ç§äºº</option>
                            <option value="å…¬å…±" ${remindTag === 'å…¬å…±' ? 'selected' : ''}>å…¬å…±</option>
                        </select>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="saveRemind('${task.id}')" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">ä¿å­˜</button>
                        <button onclick="toggleRemindPanel('${task.id}')" class="px-3 py-1 bg-gray-200 text-gray-600 rounded hover:bg-gray-300 text-sm">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
        }

        function toggleRemindPanel(taskId) {
            const panel = document.getElementById(`remind-panel-${taskId}`);
            if (panel) {
                panel.classList.toggle('active');

                // ç»‘å®šå°æ—¶/æ˜ŸæœŸ/æ—¥æœŸæŒ‰é’®ç‚¹å‡»äº‹ä»¶
                if (panel.classList.contains('active')) {
                    panel.querySelectorAll('.hour-btn').forEach(btn => {
                        btn.onclick = () => btn.classList.toggle('selected');
                    });
                    panel.querySelectorAll('.weekday-btn').forEach(btn => {
                        btn.onclick = () => btn.classList.toggle('selected');
                    });
                    panel.querySelectorAll('.day-btn').forEach(btn => {
                        btn.onclick = () => btn.classList.toggle('selected');
                    });
                }
            }
        }

        function onRemindTypeChange(taskId, type) {
            const panel = document.getElementById(`remind-panel-${taskId}`);
            if (!panel) return;

            // éšè—æ‰€æœ‰é€‰é¡¹
            panel.querySelectorAll('.remind-once-options, .remind-daily-options, .remind-weekly-options, .remind-monthly-options').forEach(el => {
                el.classList.add('hidden');
            });

            // æ˜¾ç¤ºå¯¹åº”é€‰é¡¹
            if (type === 'once') {
                panel.querySelector('.remind-once-options')?.classList.remove('hidden');
            } else if (type === 'daily') {
                panel.querySelector('.remind-daily-options')?.classList.remove('hidden');
            } else if (type === 'weekly') {
                panel.querySelector('.remind-weekly-options')?.classList.remove('hidden');
            } else if (type === 'monthly') {
                panel.querySelector('.remind-monthly-options')?.classList.remove('hidden');
            }
        }

        async function saveRemind(taskId) {
            const panel = document.getElementById(`remind-panel-${taskId}`);
            if (!panel) return;

            const type = panel.querySelector('.remind-type-select').value;
            const remindTag = panel.querySelector('.remind-tag-select').value;

            let remind = null;

            if (type === 'once') {
                const at = panel.querySelector('.remind-once-at').value;
                if (at) {
                    remind = { type: 'once', at: at };
                }
            } else if (type === 'daily') {
                const hours = [];
                panel.querySelectorAll('.hour-btn.selected').forEach(btn => {
                    hours.push(parseInt(btn.dataset.hour));
                });
                if (hours.length > 0) {
                    remind = { type: 'daily', hours: hours.sort((a, b) => a - b) };
                }
            } else if (type === 'weekly') {
                const weekdays = [];
                panel.querySelectorAll('.weekday-btn.selected').forEach(btn => {
                    weekdays.push(parseInt(btn.dataset.weekday));
                });
                const hour = parseInt(panel.querySelector('.remind-hour-select').value);
                if (weekdays.length > 0) {
                    remind = { type: 'weekly', weekdays: weekdays.sort((a, b) => a - b), hour };
                }
            } else if (type === 'monthly') {
                const days = [];
                panel.querySelectorAll('.day-btn.selected').forEach(btn => {
                    days.push(parseInt(btn.dataset.day));
                });
                const hour = parseInt(panel.querySelector('.remind-hour-select').value);
                if (days.length > 0) {
                    remind = { type: 'monthly', days: days.sort((a, b) => a - b), hour };
                }
            }

            try {
                await fetch(`/api/todo/tasks/${taskId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        remind: remind,
                        remind_tag: remindTag,
                    }),
                });
                await loadTasks();
            } catch (e) {
                console.error('ä¿å­˜æé†’å¤±è´¥', e);
            }
        }

        async function addTask(parentId = null) {
            const input = document.getElementById('new-task-input');
            const title = input.value.trim();
            if (!title) return;

            try {
                await fetch('/api/todo/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        important: newTaskImportant,
                        parent_id: parentId,
                    }),
                });
                input.value = '';
                newTaskImportant = false;
                document.getElementById('important-btn').textContent = 'â˜†';
                document.getElementById('important-btn').classList.remove('text-yellow-500');
                document.getElementById('important-btn').classList.add('text-gray-400');
                await loadTasks();
            } catch {}
        }

        async function completeTask(taskId) {
            try {
                await fetch(`/api/todo/tasks/${taskId}/complete`, { method: 'POST' });
                await loadTasks();
            } catch {}
        }

        async function toggleImportant(taskId) {
            try {
                await fetch(`/api/todo/tasks/${taskId}/toggle-important`, { method: 'POST' });
                await loadTasks();
            } catch {}
        }

        async function deleteTask(taskId) {
            try {
                await fetch(`/api/todo/tasks/${taskId}`, { method: 'DELETE' });
                await loadTasks();
            } catch {}
        }

        function promptAddSubtask(parentId) {
            const title = prompt('å­ä»»åŠ¡æ ‡é¢˜:');
            if (title && title.trim()) {
                fetch('/api/todo/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title.trim(),
                        parent_id: parentId,
                    }),
                }).then(() => loadTasks());
            }
        }
    </script>
</body>
</html>
